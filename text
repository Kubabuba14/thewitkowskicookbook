To connect to the NBS UNIclass REST API through Excel and retrieve data using Power Query (M Language), you need to create two queries in Power Query:

Query to Fetch Access Token.
Query to Use Access Token and Retrieve Data from the API.
Here’s how you can do it step-by-step:

Step 1: Fetch Access Token
Open Excel:

Open Excel and go to the Data tab.
Get Data from Web:

Click on Get Data > From Other Sources > Blank Query.
Open Advanced Editor:

In the Power Query Editor, go to Home > Advanced Editor.
Insert M Code to Fetch Access Token:

Replace the placeholders with your actual API credentials.
m
Copy code
let
    // Define constants
    clientId = "your_client_id_here",
    clientSecret = "your_client_secret_here",
    authorityUrl = "https://identity.thenbs.com/core/connect/token",
    
    // Request body
    requestBody = "grant_type=client_credentials&client_id=" & clientId & "&client_secret=" & clientSecret,
    
    // Request headers
    headers = [
        #"Content-Type" = "application/x-www-form-urlencoded"
    ],
    
    // Fetch access token
    tokenResponse = Web.Contents(authorityUrl, [
        Content = Text.ToBinary(requestBody),
        Headers = headers,
        ManualStatusHandling = {400}
    ]),
    
    // Parse JSON response
    jsonResponse = Json.Document(tokenResponse),
    accessToken = jsonResponse[access_token]
in
    accessToken
Rename the Query:
Rename this query to GetAccessToken by right-clicking on the query name in the Queries pane and selecting Rename.
Step 2: Use Access Token to Fetch Data from the API
Create a New Blank Query:

Go to Home > New Source > Blank Query.
Open Advanced Editor:

In the Power Query Editor, go to Home > Advanced Editor.
Insert M Code to Use Access Token and Fetch Data:

Replace {notation} and {depth} with actual values or parameters.
m
Copy code
let
    // Fetch access token (assuming previous step code is placed in a named query like GetAccessToken)
    accessToken = GetAccessToken,
    
    // Define API endpoint (replace {notation} and {depth} with actual values)
    notation = "your_notation_here",
    depth = "your_depth_here",
    apiUrl = "https://toolkit-api.thenbs.com/definitions/uniclass2015/" & notation & "/" & depth,
    
    // Define request headers with the access token
    headers = [
        #"Authorization" = "Bearer " & accessToken,
        #"Content-Type" = "application/json"
    ],
    
    // Fetch data from API
    response = Web.Contents(apiUrl, [
        Headers = headers
    ]),
    
    // Parse JSON response
    jsonResponse = Json.Document(response),
    table = Table.FromList(jsonResponse, Splitter.SplitByNothing(), null, null, ExtraValues.Error)
in
    table
Modify API URL and Headers as Needed:

Ensure you correctly format the API URL and include any necessary parameters.
Load Data into Excel:

After transforming the data as needed, click Close & Load to load the data into an Excel worksheet.
Conclusion
By following these steps, you create a seamless connection to the NBS UNIclass REST API using Excel’s Power Query. This method allows you to fetch an access token and use it to authenticate subsequent requests to the API, enabling you to retrieve and analyze data directly in Excel.
